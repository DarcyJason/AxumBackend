{"schemas":"DEFINE TABLE OVERWRITE audit_log SCHEMAFULL;\n\nDEFINE FIELD OVERWRITE user_id ON audit_log TYPE option<record<user>>;\nDEFINE FIELD OVERWRITE action ON audit_log TYPE string;\nDEFINE FIELD OVERWRITE status ON audit_log TYPE string;\nDEFINE FIELD OVERWRITE ip ON audit_log TYPE option<string>;\nDEFINE FIELD OVERWRITE user_agent ON audit_log TYPE option<string>;\nDEFINE FIELD OVERWRITE detail ON audit_log TYPE option<string>;\nDEFINE FIELD OVERWRITE created_at ON audit_log TYPE datetime;\n\nDEFINE INDEX OVERWRITE idx_audit_log_created_at ON audit_log FIELDS created_at;\nDEFINE INDEX OVERWRITE idx_audit_log_with_user_id ON audit_log FIELDS user_id;\nDEFINE INDEX OVERWRITE idx_audit_log_action ON audit_log FIELDS action;\nDEFINE INDEX OVERWRITE idx_audit_log_user_action_time ON audit_log FIELDS user_id, action, created_at;\nDEFINE INDEX OVERWRITE idx_audit_log_status ON audit_log FIELDS status;\n\nDEFINE TABLE OVERWRITE device SCHEMAFULL;\n\nDEFINE FIELD OVERWRITE user_id ON device TYPE record<user>;\nDEFINE FIELD OVERWRITE device_name ON device TYPE string;\nDEFINE FIELD OVERWRITE device_type ON device TYPE string;\nDEFINE FIELD OVERWRITE raw_user_agent ON device TYPE string;\nDEFINE FIELD OVERWRITE first_login_at ON device TYPE datetime;\nDEFINE FIELD OVERWRITE last_login_at ON device TYPE datetime;\nDEFINE FIELD OVERWRITE ip ON device TYPE string;\nDEFINE FIELD OVERWRITE is_trusted ON device TYPE bool;\n\nDEFINE INDEX OVERWRITE idx_device_with_user_id ON device FIELDS user_id;\nDEFINE INDEX OVERWRITE idx_device_name_with_user_id ON device FIELDS user_id, device_name UNIQUE;\nDEFINE INDEX OVERWRITE idx_device_type_with_user_id ON device FIELDS user_id, device_type;\nDEFINE INDEX OVERWRITE idx_device_trusted_with_user_id ON device FIELDS user_id, is_trusted;\nDEFINE INDEX OVERWRITE idx_device_user_last_login_at ON device FIELDS user_id, last_login_at;\n\nDEFINE TABLE OVERWRITE refresh_token SCHEMAFULL;\n\nDEFINE FIELD OVERWRITE user_id ON refresh_token TYPE record<user>;\nDEFINE FIELD OVERWRITE token_hashed ON refresh_token TYPE string;\nDEFINE FIELD OVERWRITE device ON refresh_token TYPE record<device>;\nDEFINE FIELD OVERWRITE ip ON refresh_token TYPE string;\nDEFINE FIELD OVERWRITE created_at ON refresh_token TYPE datetime;\nDEFINE FIELD OVERWRITE expires_at ON refresh_token TYPE datetime;\nDEFINE FIELD OVERWRITE is_revoked ON refresh_token TYPE bool;\n\nDEFINE INDEX OVERWRITE idx_refresh_token_token_hashed ON refresh_token FIELDS token_hashed UNIQUE;\nDEFINE INDEX OVERWRITE idx_refresh_token_with_user_id ON refresh_token FIELDS user_id;\nDEFINE INDEX OVERWRITE idx_refresh_token_with_device ON refresh_token FIELDS device;\nDEFINE INDEX OVERWRITE idx_refresh_token_valid_token ON refresh_token FIELDS token_hashed, is_revoked, expires_at;\nDEFINE INDEX OVERWRITE idx_refresh_token_expired_token ON refresh_token FIELDS expires_at;\n\nDEFINE TABLE OVERWRITE script_migration SCHEMAFULL\n    PERMISSIONS\n        FOR select FULL\n        FOR create, update, delete NONE;\n\nDEFINE FIELD OVERWRITE script_name ON script_migration TYPE string;\nDEFINE FIELD OVERWRITE executed_at ON script_migration TYPE datetime VALUE time::now() READONLY;\nDEFINE FIELD OVERWRITE checksum ON script_migration TYPE option<string>;\n\nDEFINE TABLE OVERWRITE user SCHEMAFULL\nPERMISSIONS\n    FOR create\n        WHERE $auth != NONE\n    FOR select\n        WHERE $auth.role in [\"Admin\", \"SystemOwner\"]\n        OR id == $auth.id\n    FOR update\n        WHERE $auth.role == \"SystemOwner\"\n        OR (\n            $auth.role == \"Admin\"\n            AND role != \"SystemOwner\"\n            AND id == $auth.id\n        )\n    FOR delete\n        WHERE $auth.role == \"SystemOwner\"\n        OR ($auth.role == \"Admin\" AND role != \"SystemOwner\");\n\nDEFINE FIELD OVERWRITE name ON user TYPE string ASSERT\n    {\n        IF string::len($value) > 2 && string::len($value) < 20 {\n            RETURN true\n        } ELSE {\n            THROW \"Name length must be between 3 and 20 characters\"\n        }\n    };\nDEFINE FIELD OVERWRITE email ON user TYPE string ASSERT\n    {\n        IF string::is::email($value) {\n            RETURN true\n        } ELSE {\n            THROW \"Invalid email format\"\n        }\n    };\nDEFINE FIELD OVERWRITE password_hashed ON user TYPE string ASSERT\n    {\n        IF string::len($value) > 0 {\n            RETURN true\n        } ELSE {\n            THROW \"Password hash cannot be empty\"\n        }\n    };\nDEFINE FIELD OVERWRITE role ON user TYPE string ASSERT\n    {\n        IF $value IN [\"User\", \"Admin\", \"SystemOwner\"] {\n            RETURN true\n        } ELSE {\n            THROW \"Invalid role value\"\n        }\n    }\n    PERMISSIONS FOR update WHERE $auth.role = \"SystemOwner\";\nDEFINE FIELD OVERWRITE is_verified ON user TYPE bool DEFAULT false;\nDEFINE FIELD OVERWRITE is_banned ON user TYPE bool DEFAULT false;\nDEFINE FIELD OVERWRITE created_at ON user TYPE datetime DEFAULT time::now() READONLY;\nDEFINE FIELD OVERWRITE updated_at ON user TYPE datetime DEFAULT time::now();\n\n\nDEFINE INDEX OVERWRITE idx_user_email ON user FIELDS email UNIQUE;\nDEFINE INDEX OVERWRITE idx_user_role ON user FIELDS role;\nDEFINE INDEX OVERWRITE idx_user_is_banned ON user FIELDS is_banned;\nDEFINE INDEX OVERWRITE idx_user_created_at ON user FIELDS created_at;\n","events":""}